


<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="en">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
        Ruby 基础篇之如何山寨 require 和 load
 - Terr Tai's Blog
    </title>

    <meta name="description" content="Terry Tai is on his way!">
    <meta name="keywords" content="  ["ruby", "require", "load"]
">
    <meta name="author" content="poshboytl">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cleartype" content="on">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="57x57" href="/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png" />
    <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="shortcut icon" sizes="16x16" href="/favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="Terr Tai's Homepage" href="/feed.xml" />
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/stylesheets/application.css?1392264256" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/application.js?1392264255" type="text/javascript"></script>

  </head>
  <body class="ruby-basics-how-to-faux-require-and-load ruby-basics-how-to-faux-require-and-load_index">
    <aside class="sidebar">
      <h1 class="site-name"><a href="/">Terry</a></h1>
      <nav class="global-nav">
        <ul>
          <li><a href="/">Posts</a></li>
          <li><a href="#TODO">Photos</a></li>
          <li><a href="/profile">Profile</a></li>
        </ul>        
      </nav>

      <nav class="social-connect">
        <ul>
          <li><a href="//weibo.com/poshboytl"><i class="icon-weibo"></i></a></li>
          <li><a href="//twitter.com/poshboytl"><i class="icon-twitter"></i></a></li>
          <li><a href="//facebook.com/terry.tai.man"><i class="icon-facebook"></i></a></li>
          <li><a href="/rss.xml"><i class="icon-rss"></i></a></li>
        </ul>
      </nav>
      
      <!-- Ad -->
      <div class="block ad">
        <h4 class="block-title"><a href="//fengche.co/">Fengche.co</a></h4>
        <p class="block-cnt">团队协作工具</p>
      </div>

    </aside>

    <section class="main">
      <div class="container">
        
  <div class="announcement">
    <p>
      
        <img class="avatar" src="/images/terrytai.png" alt="Terry Tai" />
如果你的项目需要人帮助做架构, 重构或开发, 欢迎找我做咨询！联系方式: Skype: terrytie | QQ: 6123035

      
    </p>
  </div>

  <article class="post single">

    <header>
  <h2 class="title">
    <a href="/ruby-basics-how-to-faux-require-and-load">Ruby 基础篇之如何山寨 require 和 load</a>
  </h2>
</header>

<aside class="aside-block">
  <ul class="meta">
    <!-- <li class="author-photo">
      <a href="http://terrytai.com">
        <img src="/images/terrytai.png?1392187460" />
      </a>
    </li>
    <li class="author">
     by Terry Tai
    </li> -->
    <li class="date">
      Apr 26, 2013
    </li>
    <li class="tags">
      
        <a href="/tags/ruby">ruby</a>
      
        <a href="/tags/require">require</a>
      
        <a href="/tags/load">load</a>
      
    </li>
  </ul>
</aside>

<div class="content">
  <p><img src="https://writingsio.s3.amazonaws.com/attachments/517a53014017a4561a000230/bfb3a2863ae41f9a84f92846d787e5b8/shanzhai.jpg" /></p>

<p>前几天被一个初学 Ruby 的同学问及 require 和 load 有什么区别。后来想想这个问题虽然答案并不难，但是还可以引申出不少可以探讨的内容。所以我打算通过山寨一个 require 和 load 的方法的形式，来阐述一些内容。</p>

<p>在开始之前我们首先假设我们有一个 person.rb 文件，内容如下:</p>

<pre><code>class Person

  attr_reader :name, :age

  def initialize(name, age)
    @name = name
    @age = age
  end

  def to_s
    &quot;My name is #{name} and I&#39;m #{age} years old!&quot;
  end

end

person = Person.new(&quot;金将军&quot;, 30)
puts person.to_s  
</code></pre>

<h2>先来山寨 load</h2>

<p>先让我们来做做试验。</p>

<pre><code># -*- coding: utf-8 -*-
# try_load_require.rb

load &#39;./person.rb&#39;
load &#39;./person.rb&#39;

$ ruby try_load_require.rb
My name is 金将军 and I&#39;m 30 years old!
My name is 金将军 and I&#39;m 30 years old!
</code></pre>

<p>我们这里调用了 两次 load ，发现 person.rb 被调用了两次。这说明 load 是不会判断文件是否已经加载，只是简单的加载并运行了内容。</p>

<p>换言之我们可以自己山寨一个 load 方法来达到同样的目的：</p>

<pre><code># -*- coding: utf-8 -*-
# try_load_require.rb

def load(file_with_path)
  puts &quot;这是山寨load()&quot;
  eval File.read(file_with_path)
end

load &#39;./person.rb&#39;
load &#39;./person.rb&#39;
</code></pre>

<p>其实如果你细心看过 load 方法的文档的话你会发现 load 实际上是可以接受第二个参数的，并且这个方法的返回值恒定为 true</p>

<pre><code>load(filename, wrap=false) #=&gt; true
</code></pre>

<p>wrap 参数到底有什么用？我们需要重新来做一个试验：</p>

<pre><code># -*- coding: utf-8 -*-
# try_load_require.rb

def check_person_defined
  begin
    puts &quot;Person class is defined&quot; if Person
  rescue NameError
    puts  &quot;Person class is not defined&quot;
  end
end

load &#39;./person.rb&#39;, true
check_person_defined

load &#39;./person.rb&#39;
check_person_defined
</code></pre>

<p>而输出结果是：</p>

<pre><code>ruby try_load_require.rb
My name is 金将军 and I&#39;m 30 years old!
Person class is not defined
My name is 金将军 and I&#39;m 30 years old!
Person class is defined
</code></pre>

<p>这说明当我们调用 load 时把第二个参数设为 true，虽然执行了 person.rb 的代码，但是 Person 的定义并不能在当前作用域起作用。那可以通过在一个匿名的作用域来执行person就可以达到相同效果了。所以我们可以继续做更完整的做如下山寨：</p>

<pre><code>def load(file_with_path, warp = false)
  puts &quot;这是山寨load()&quot;
  if warp
    Module.new.module_eval(File.read(file_with_path))
  else
    eval File.read(file_with_path)
  end
  true
end
</code></pre>

<h2>接下来山寨 require</h2>

<p>用同样的方法我们来测试一下 require</p>

<pre><code># -*- coding: utf-8 -*-
# try_load_require.rb

require &#39;./person.rb&#39; #=&gt; true
require &#39;./person.rb&#39; #=&gt; false
</code></pre>

<p>而输出结果是：</p>

<pre><code>$ ruby try_load_require.rb
My name is 金将军 and I&#39;m 30 years old!
</code></pre>

<p>这说明 require 是会判断文件是否已经被加载，如果被加载的话是不会再进行重复加载的。并且第一次加载成功会返回 true，如果判断为重复加载会返回 false。</p>

<p>知道这个简单的规则后，我们就可以做如下山寨了并且会用到我们刚刚的山寨 load 哟 :)</p>

<pre><code>$required_files = []

def require(file_with_path)
  puts &quot;这是山寨require()&quot;
  full_path = File.expand_path(file_with_path)
  if $required_files.include?(full_path)
    return false
  else
    $required_files &lt;&lt; full_path
    load(full_path)
    return true
  end
end
</code></pre>

<p>怎么样, 简单吧？ 希望通过这个简单的山寨能让初学的朋友能更好的理解和记忆 require 和 load 的区别。</p>

<p>那什么时候用 load 什么时候用 require 呢？在大多数情况下我们都是使用 require 的。但是有些时候需要多次加载一个变化的文件，比如像 Rails 的 development 模式的 server 启起来以后，需要再次加载改变的源文件那么就需要用到 load (或者 autoload, 以后会谈到)。</p>

<p>以后我还会写一系列的针对 Ruby 基础知识的文章，敬请期待哟. :)</p>

<p>BTW, 最近我建立了一个 Ruby/Rails 学习QQ群 231618869，学习 Ruby/Rails 的同学可以在这里交流经验和你遇到的问题哟。</p>

</div>


  </article>

  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'terrytaiblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

      </div>
    </section>
    
    <footer>
      <div class="copyright">
        <p>&copy;2013 Terry Tai</p>
      </div>
    </footer>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-103363-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
